# SN码唯一性验证测试指南

## 🎯 测试目标

验证SN码在所有场景下都不能重复录入，确保"一物一码"的唯一性。

## 📝 测试前准备

1. **重启后端服务**（应用新的API接口）
   ```bash
   cd backend/ruoyi-admin-wms
   mvn spring-boot:run
   ```

2. **刷新前端浏览器**
   - 按 `Ctrl + Shift + R` 硬刷新

3. **准备测试数据**
   - 确保数据库中有一些测试用的SN码
   - 或者准备新的SN码用于测试

## 🧪 测试用例

### 测试1：新增入库单 - 重复SN码验证

**步骤：**
1. 进入"入库单管理"
2. 点击"新增"按钮
3. 填写基本信息（仓库、库区、入库类型等）
4. 添加一个商品，数量设为 3
5. 点击"录入SN码"按钮
6. 输入 `TEST001`，点击"添加"
7. ✅ **验证点1**：应提示"已添加SN码: TEST001（已通过验证）"
8. 再次输入 `TEST001`，点击"添加"
9. ✅ **验证点2**：应提示"SN码已存在，请勿重复录入"
10. 输入 `TEST002`，点击"添加"
11. ✅ **验证点3**：应成功添加
12. 输入 `TEST003`，点击"添加"
13. ✅ **验证点4**：应成功添加

**预期结果：**
- 第一次输入TEST001成功
- 第二次输入TEST001失败（本地或服务器验证）
- TEST002和TEST003都成功添加
- 当前SN码列表：[TEST001, TEST002, TEST003]

---

### 测试2：编辑入库单 - 保留原SN码

**步骤：**
1. 使用测试1创建的入库单（假设已保存，ID=1）
2. 点击"修改"按钮
3. 找到商品明细，点击"录入SN码"
4. 当前应该显示：[TEST001, TEST002, TEST003]
5. 删除 TEST002（点击×号）
6. 现在列表：[TEST001, TEST003]
7. 重新输入 `TEST002`，点击"添加"
8. ✅ **验证点1**：应成功添加（因为TEST002在原列表中）
9. 点击"确定"保存SN码

**预期结果：**
- 删除后可以重新添加原有的SN码
- 最终SN码列表：[TEST001, TEST003, TEST002]

---

### 测试3：跨订单SN码重复验证

**准备：**
- 订单A已有SN码：TEST001
- 订单B是新订单

**步骤：**
1. 创建新的入库单（订单B）
2. 添加商品，数量=2
3. 点击"录入SN码"
4. 输入 `TEST001`（订单A已使用的SN码）
5. 点击"添加"
6. ✅ **验证点1**：应提示"SN码已存在，请勿重复录入"
7. 输入 `TEST004`（新SN码）
8. ✅ **验证点2**：应成功添加

**预期结果：**
- 不能录入其他订单已使用的SN码
- 新SN码可以正常录入

---

### 测试4：扫描模式快速录入

**步骤：**
1. 创建新入库单
2. 添加商品，数量=5
3. 点击"录入SN码"，选择扫描模式
4. 快速连续输入以下SN码（模拟扫描枪）：
   - `SCAN001` + 回车
   - `SCAN002` + 回车
   - `SCAN003` + 回车
   - `SCAN001` + 回车  ← 重复
   - `SCAN004` + 回车
   - `SCAN005` + 回车
5. ✅ **验证点1**：SCAN001第一次成功
6. ✅ **验证点2**：SCAN001第二次失败（提示已存在）
7. ✅ **验证点3**：输入框自动聚焦等待下一次扫描
8. ✅ **验证点4**：最终列表：[SCAN001, SCAN002, SCAN003, SCAN004, SCAN005]

**预期结果：**
- 扫描模式下重复SN码也会被拒绝
- 错误后自动聚焦，可继续扫描
- 扫描完成后提示"已录入完成"

---

### 测试5：出库单SN码验证

**步骤：**
1. 进入"出库单管理"
2. 点击"新增"
3. 填写基本信息
4. 选择库存商品
5. 点击"录入SN码"
6. 输入一个数据库中已存在的SN码
7. ✅ **验证点1**：应提示"SN码已存在"
8. 输入新的SN码
9. ✅ **验证点2**：应成功添加

**预期结果：**
- 出库单也遵循SN码唯一性规则
- 验证逻辑与入库单一致

---

### 测试6：数据库层面唯一性保证

**步骤（需要数据库访问权限）：**
1. 直接在数据库插入重复SN码：
   ```sql
   INSERT INTO wms_serial_number (sn_code, ...) VALUES ('DUPLICATE001', ...);
   INSERT INTO wms_serial_number (sn_code, ...) VALUES ('DUPLICATE001', ...);
   ```
2. ✅ **验证点**：第二条INSERT应该失败，提示违反唯一约束

**预期结果：**
- 数据库约束生效
- 错误信息：Duplicate entry 'DUPLICATE001' for key 'uk_sn_code'

---

## 📊 测试结果记录表

| 测试用例 | 测试时间 | 测试结果 | 备注 |
|---------|---------|---------|------|
| 测试1：新增重复验证 | ______ | ☐ 通过 ☐ 失败 | |
| 测试2：编辑保留原SN | ______ | ☐ 通过 ☐ 失败 | |
| 测试3：跨订单验证 | ______ | ☐ 通过 ☐ 失败 | |
| 测试4：扫描模式 | ______ | ☐ 通过 ☐ 失败 | |
| 测试5：出库单验证 | ______ | ☐ 通过 ☐ 失败 | |
| 测试6：数据库约束 | ______ | ☐ 通过 ☐ 失败 | |

## 🔍 验证清单

- [ ] 本地前端验证正常（立即提示重复）
- [ ] 后端API验证正常（实时检查数据库）
- [ ] 编辑模式支持排除已有SN码
- [ ] 错误提示清晰友好
- [ ] 扫描模式自动聚焦
- [ ] 数据库唯一约束生效

## ⚠️ 常见问题

### 问题1：还是能录入重复SN码

**可能原因：**
1. 后端服务未重启
2. 前端缓存未清除
3. API接口路径错误

**解决方法：**
1. 重启后端服务
2. 清除浏览器缓存（Ctrl+Shift+R）
3. 检查浏览器控制台的Network标签，查看API调用

### 问题2：提示"接口调用失败"

**可能原因：**
1. 后端服务未启动
2. 网络连接问题
3. 接口路径错误

**解决方法：**
1. 确认后端服务运行正常
2. 检查浏览器控制台的错误信息
3. 验证API路径：`POST /wms/sn/input`

### 问题3：编辑时不能重新添加原SN码

**可能原因：**
- 排除列表未正确传递

**解决方法：**
1. 检查SnInputDialog组件的props
2. 确认existingSnCodes正确传递
3. 查看浏览器控制台的日志

## 🐛 调试方法

### 1. 查看浏览器控制台

按F12打开开发者工具，查看：
- **Console**：查看调用日志和错误
- **Network**：查看API请求和响应

### 2. 查看API调用

在Network标签中找到 `/wms/sn/input` 请求，查看：
- **Request Payload**：
  ```json
  {
    "snCode": "TEST001",
    "excludeSnCodes": ["SN001", "SN002"]
  }
  ```
- **Response**：
  ```json
  {
    "code": 200,
    "msg": "SN码验证通过"
  }
  ```
  或
  ```json
  {
    "code": 500,
    "msg": "SN码已存在，请勿重复录入"
  }
  ```

### 3. 查看后端日志

查看后端控制台输出，检查：
- SQL查询语句
- 验证逻辑执行情况
- 异常堆栈信息

## ✅ 测试通过标准

所有测试用例都通过，且满足：
1. ✅ 新增时不能录入重复SN码
2. ✅ 编辑时可以保留原有SN码
3. ✅ 不能录入其他订单的SN码
4. ✅ 扫描模式快速录入正常
5. ✅ 错误提示清晰友好
6. ✅ 数据库唯一约束生效

## 📞 问题反馈

如果测试中发现问题，请记录：

**问题描述：**
```
请详细描述遇到的问题
```

**复现步骤：**
```
1. ...
2. ...
3. ...
```

**预期结果：**
```
应该看到什么
```

**实际结果：**
```
实际看到什么
```

**错误信息：**
```
浏览器控制台或后端日志的错误信息
```

**截图：**
```
如果可能，请提供截图
```

---

**测试人员：** ______________

**测试日期：** ______________

**测试环境：** ______________

**测试结果：** ☐ 全部通过 ☐ 部分通过 ☐ 未通过

**备注：** ______________________________

