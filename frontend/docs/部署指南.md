# 仓库地图系统部署指南

## 部署前准备

### 系统要求

#### 服务器配置
- **CPU**: 2核或以上
- **内存**: 4GB或以上
- **硬盘**: 20GB可用空间
- **操作系统**: Linux (推荐 Ubuntu 20.04+) / Windows Server 2016+

#### 软件环境
- **Node.js**: 16.x 或以上
- **pnpm**: 7.x 或以上
- **Java**: JDK 17 或以上
- **Maven**: 3.6+ 或以上
- **MySQL**: 8.0 或以上
- **Nginx**: 1.18+ (可选，用于生产环境)

### 依赖检查

```bash
# 检查 Node.js 版本
node -v  # 应该显示 v16.x 或更高

# 检查 pnpm 版本
pnpm -v  # 应该显示 7.x 或更高

# 检查 Java 版本
java -version  # 应该显示 17 或更高

# 检查 Maven 版本
mvn -v  # 应该显示 3.6 或更高

# 检查 MySQL 版本
mysql --version  # 应该显示 8.0 或更高
```

## 数据库部署

### 1. 创建数据库

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS wms_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建用户（可选）
CREATE USER 'wms_user'@'localhost' IDENTIFIED BY 'your_password_here';

-- 授权
GRANT ALL PRIVILEGES ON wms_db.* TO 'wms_user'@'localhost';
FLUSH PRIVILEGES;
```

### 2. 导入数据表

```bash
# 导入主数据库
mysql -u root -p wms_db < backend/script/sql/wms.sql

# 导入仓库地图表
mysql -u root -p wms_db < backend/script/sql/warehouse_map.sql
```

### 3. 验证数据库

```sql
-- 连接数据库
mysql -u root -p wms_db

-- 检查表是否存在
SHOW TABLES;

-- 应该看到以下表：
-- wms_warehouse_map
-- wms_path_record
-- ...其他WMS表
```

## 后端部署

### 开发环境部署

#### 1. 配置文件修改

编辑 `backend/ruoyi-admin-wms/src/main/resources/application-dev.yml`:

```yaml
# 数据源配置
spring:
  datasource:
    type: com.zaxxer.hikari.HikariDataSource
    driverClassName: com.mysql.cj.jdbc.Driver
    hikari:
      # 修改为你的数据库地址
      jdbc-url: jdbc:mysql://localhost:3306/wms_db?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=true&serverTimezone=GMT%2B8
      # 修改为你的数据库用户名
      username: wms_user
      # 修改为你的数据库密码
      password: your_password_here
```

#### 2. 编译项目

```bash
cd backend
mvn clean install -DskipTests
```

#### 3. 启动服务

```bash
cd ruoyi-admin-wms
mvn spring-boot:run
```

或者直接运行jar包：

```bash
cd ruoyi-admin-wms/target
java -jar ruoyi-admin-wms.jar
```

#### 4. 验证后端

访问：`http://localhost:8080`

如果看到API文档或登录页面，说明后端启动成功。

### 生产环境部署

#### 1. 修改生产配置

编辑 `backend/ruoyi-admin-wms/src/main/resources/application-prod.yml`:

```yaml
# 服务器配置
server:
  port: 8080
  servlet:
    context-path: /api

# 数据源配置
spring:
  datasource:
    type: com.zaxxer.hikari.HikariDataSource
    driverClassName: com.mysql.cj.jdbc.Driver
    hikari:
      jdbc-url: jdbc:mysql://your-db-host:3306/wms_db?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=true&serverTimezone=GMT%2B8
      username: wms_user
      password: your_secure_password_here
      maximum-pool-size: 20
      minimum-idle: 5

# 日志配置
logging:
  level:
    root: INFO
    com.ruoyi: INFO
  file:
    name: /var/log/wms/wms.log
    max-size: 100MB
    max-history: 30
```

#### 2. 打包项目

```bash
cd backend
mvn clean package -DskipTests -P prod
```

#### 3. 部署到服务器

```bash
# 上传jar包到服务器
scp backend/ruoyi-admin-wms/target/ruoyi-admin-wms.jar user@your-server:/opt/wms/

# SSH到服务器
ssh user@your-server

# 创建日志目录
sudo mkdir -p /var/log/wms
sudo chown your-user:your-user /var/log/wms

# 启动服务
cd /opt/wms
nohup java -jar ruoyi-admin-wms.jar --spring.profiles.active=prod > /dev/null 2>&1 &
```

#### 4. 创建系统服务（推荐）

创建 `/etc/systemd/system/wms.service`:

```ini
[Unit]
Description=WMS Application
After=syslog.target network.target

[Service]
Type=simple
User=your-user
WorkingDirectory=/opt/wms
ExecStart=/usr/bin/java -jar /opt/wms/ruoyi-admin-wms.jar --spring.profiles.active=prod
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启动服务：

```bash
sudo systemctl daemon-reload
sudo systemctl start wms
sudo systemctl enable wms
sudo systemctl status wms
```

## 前端部署

### 开发环境部署

#### 1. 安装依赖

```bash
cd frontend
pnpm install
```

#### 2. 配置环境变量

编辑 `frontend/.env.development`:

```env
# 页面标题
VITE_APP_TITLE = 仓库管理系统

# 开发环境配置
VITE_APP_ENV = 'development'

# 若依管理系统/开发环境
VITE_APP_BASE_API = 'http://localhost:8080'

# 路由模式
VITE_APP_CONTEXT_PATH = '/'
```

#### 3. 启动开发服务器

```bash
pnpm dev
```

访问：`http://localhost:80`

### 生产环境部署

#### 1. 配置生产环境变量

编辑 `frontend/.env.production`:

```env
# 页面标题
VITE_APP_TITLE = 仓库管理系统

# 生产环境配置
VITE_APP_ENV = 'production'

# 若依管理系统/生产环境
VITE_APP_BASE_API = 'https://your-domain.com/api'

# 路由模式
VITE_APP_CONTEXT_PATH = '/'
```

#### 2. 构建生产版本

```bash
cd frontend
pnpm build:prod
```

构建完成后，生成的文件在 `frontend/dist` 目录。

#### 3. 部署到Nginx

##### 3.1 安装Nginx

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install nginx

# CentOS/RHEL
sudo yum install nginx
```

##### 3.2 配置Nginx

创建 `/etc/nginx/sites-available/wms`:

```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    # 前端静态文件
    root /var/www/wms/dist;
    index index.html;
    
    # 开启gzip压缩
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    
    # 前端路由配置
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # API代理
    location /api/ {
        proxy_pass http://localhost:8080/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    
    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

##### 3.3 启用站点并重启Nginx

```bash
# Ubuntu/Debian
sudo ln -s /etc/nginx/sites-available/wms /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx

# CentOS/RHEL
sudo nginx -t
sudo systemctl restart nginx
```

##### 3.4 上传前端文件

```bash
# 在本地打包
cd frontend
pnpm build:prod

# 上传到服务器
scp -r dist/* user@your-server:/var/www/wms/dist/
```

#### 4. 配置HTTPS（推荐）

##### 4.1 申请SSL证书

使用 Let's Encrypt 免费证书：

```bash
# 安装 certbot
sudo apt install certbot python3-certbot-nginx

# 申请证书
sudo certbot --nginx -d your-domain.com
```

##### 4.2 自动续期

```bash
# 测试自动续期
sudo certbot renew --dry-run

# 设置定时任务
sudo crontab -e
# 添加以下行
0 3 * * * certbot renew --quiet
```

## Docker部署（推荐）

### 1. 创建Dockerfile

#### 后端Dockerfile

创建 `backend/Dockerfile`:

```dockerfile
FROM openjdk:17-jdk-slim

WORKDIR /app

COPY ruoyi-admin-wms/target/ruoyi-admin-wms.jar app.jar

EXPOSE 8080

ENTRYPOINT ["java", "-jar", "app.jar", "--spring.profiles.active=prod"]
```

#### 前端Dockerfile

创建 `frontend/Dockerfile`:

```dockerfile
FROM node:16-alpine as builder

WORKDIR /app

COPY package.json pnpm-lock.yaml ./
RUN npm install -g pnpm && pnpm install

COPY . .
RUN pnpm build:prod

FROM nginx:alpine

COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

### 2. 创建docker-compose.yml

```yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: wms-mysql
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: wms_db
      MYSQL_USER: wms_user
      MYSQL_PASSWORD: wms_password
    volumes:
      - mysql-data:/var/lib/mysql
      - ./backend/script/sql:/docker-entrypoint-initdb.d
    ports:
      - "3306:3306"
    networks:
      - wms-network

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: wms-backend
    depends_on:
      - mysql
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/wms_db
      SPRING_DATASOURCE_USERNAME: wms_user
      SPRING_DATASOURCE_PASSWORD: wms_password
    ports:
      - "8080:8080"
    networks:
      - wms-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: wms-frontend
    depends_on:
      - backend
    ports:
      - "80:80"
    networks:
      - wms-network

volumes:
  mysql-data:

networks:
  wms-network:
    driver: bridge
```

### 3. 启动Docker容器

```bash
# 构建并启动
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

## 部署验证

### 1. 检查后端服务

```bash
# 检查服务状态
curl http://localhost:8080/actuator/health

# 预期返回
{"status":"UP"}
```

### 2. 检查前端服务

访问：`http://your-domain.com/wms/map`

应该看到仓库地图页面。

### 3. 功能测试

1. 登录系统
2. 导航到"仓库地图"
3. 创建地图并设置库区
4. 计算路径
5. 播放动画

## 性能优化

### 前端优化

1. **启用CDN**
   ```javascript
   // vite.config.js
   export default {
     build: {
       rollupOptions: {
         external: ['vue', 'element-plus']
       }
     }
   }
   ```

2. **代码分割**
   ```javascript
   // 路由懒加载
   component: () => import('@/views/wms/warehouseMap')
   ```

3. **图片压缩**
   ```bash
   pnpm add -D vite-plugin-imagemin
   ```

### 后端优化

1. **连接池配置**
   ```yaml
   spring:
     datasource:
       hikari:
         maximum-pool-size: 20
         minimum-idle: 5
         connection-timeout: 30000
   ```

2. **启用缓存**
   ```java
   @Cacheable("warehouseMap")
   public WarehouseMapVo getById(Long id) {
       // ...
   }
   ```

3. **JVM参数优化**
   ```bash
   java -Xms512m -Xmx2048m -XX:+UseG1GC -jar app.jar
   ```

### Nginx优化

```nginx
# 开启gzip压缩
gzip on;
gzip_comp_level 6;
gzip_types text/plain text/css application/json application/javascript;

# 开启缓存
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}

# 限流
limit_req_zone $binary_remote_addr zone=mylimit:10m rate=10r/s;
limit_req zone=mylimit burst=20 nodelay;
```

## 监控和日志

### 1. 应用监控

使用Spring Boot Actuator：

```yaml
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
```

### 2. 日志收集

使用ELK Stack或简单的文件日志：

```yaml
logging:
  file:
    name: /var/log/wms/wms.log
  pattern:
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{50} - %msg%n"
```

### 3. 性能监控

使用Prometheus + Grafana：

```yaml
management:
  metrics:
    export:
      prometheus:
        enabled: true
```

## 备份和恢复

### 数据库备份

```bash
# 自动备份脚本
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
mysqldump -u wms_user -p wms_db > /backup/wms_db_$DATE.sql
find /backup -name "wms_db_*.sql" -mtime +7 -delete
```

### 应用备份

```bash
# 备份配置和数据
tar -czf wms_backup_$(date +%Y%m%d).tar.gz \
    /opt/wms \
    /var/www/wms \
    /etc/nginx/sites-available/wms
```

## 故障排查

### 常见问题

1. **后端无法连接数据库**
   - 检查数据库地址和端口
   - 检查用户名密码
   - 检查防火墙设置

2. **前端无法访问后端API**
   - 检查Nginx代理配置
   - 检查CORS配置
   - 检查后端服务是否运行

3. **页面白屏**
   - 检查浏览器控制台错误
   - 检查路由配置
   - 检查静态资源路径

### 日志查看

```bash
# 后端日志
tail -f /var/log/wms/wms.log

# Nginx日志
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log

# Docker日志
docker logs -f wms-backend
docker logs -f wms-frontend
```

## 安全加固

1. **数据库安全**
   - 使用强密码
   - 限制远程访问
   - 定期备份

2. **应用安全**
   - 启用HTTPS
   - 配置防火墙
   - 定期更新依赖

3. **服务器安全**
   - 禁用root登录
   - 配置SSH密钥
   - 安装fail2ban

## 更新和维护

### 应用更新

```bash
# 1. 备份当前版本
cp ruoyi-admin-wms.jar ruoyi-admin-wms.jar.backup

# 2. 上传新版本
scp new-version.jar user@server:/opt/wms/

# 3. 重启服务
sudo systemctl restart wms

# 4. 验证更新
curl http://localhost:8080/actuator/info
```

### 数据库迁移

```bash
# 1. 备份数据库
mysqldump -u root -p wms_db > backup.sql

# 2. 执行迁移脚本
mysql -u root -p wms_db < migration.sql

# 3. 验证数据
```

---

**部署完成！**

如有问题，请查看日志或联系技术支持。

