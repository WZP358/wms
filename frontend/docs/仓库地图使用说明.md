# 仓库地图系统使用说明

## 功能概述

仓库地图系统是一个货架拣货路径规划工具，主要功能包括：

1. **自定义地图大小**：可以设置货架的行数和列数
2. **选择货架**：左键点击选择需要访问的货架
3. **走廊可视化**：显示货架之间的走廊通道
4. **路径规划**：使用模拟退火算法计算最短拣货路径
5. **动态展示**：支持路径动画播放

## 核心概念

### 地图布局

- **第一行**：只有一个格子，表示仓库大门（起点/终点）
- **其他行**：每个格子代表一个货架
- **格子间隙**：代表走廊，工作人员只能在走廊中行走

### 路径规则

1. **起点和终点**：都是大门
2. **访问条件**：必须经过货架的**下底边中点**才算访问该货架
3. **行走限制**：**严格沿着走廊网格行走**，不能穿过货架，不能走直线
4. **路径查找**：使用A*算法在走廊网格中寻找实际路径
5. **距离计算**：实际在走廊中行走的距离（包含所有转折）

## 访问方式

在系统中导航到：**仓储管理 → 仓库地图** 或直接访问 `/wms/map`

## 使用步骤

### 步骤1：选择仓库

在左侧控制面板的"仓库选择"区域：

- **选择仓库**：从下拉框中选择要管理的仓库
- 系统会自动加载该仓库的库区列表
- 切换仓库时会清空当前地图的库区设置

> 注意：必须先选择仓库才能设置库区

### 步骤2：设置地图参数

在左侧控制面板的"地图设置"区域：

- **地图宽度**：设置货架的列数（3-30列）
- **地图高度**：设置货架的行数（3-30行）
- **格子大小**：调整每个货架的显示大小（40-100px）
- **走廊宽度**：调整走廊的宽度（10-40px）

设置完成后点击"重新生成地图"按钮。

> 注意：
> - 第一行永远只有一个格子，表示仓库大门
> - 走廊宽度影响实际行走距离

### 步骤3：查看和管理库区

在"库区管理"区域：

**库区数据来源**：
1. 优先从本地存储加载（浏览器缓存）
2. 如果本地没有，尝试从后端API查询
3. 如果后端不可用，自动创建默认库区
4. 所有修改都会自动保存到本地

**管理库区**：
- 系统会显示当前仓库的所有库区
- 每个库区显示：颜色标识、库区名称、库区编号
- 点击"添加库区"按钮创建新库区
- 直接编辑库区名称和编号（自动保存）
- 点击删除按钮移除库区

**右键设置库区**：
1. 在地图上右键点击任意格子（除大门外）
2. 弹出库区选择菜单
3. 选择要设置的库区
4. 格子会显示对应库区的颜色和名称
5. 可以选择"清除库区"移除设置

> 注意：
> - 库区数据存储在浏览器本地，清除浏览器缓存会丢失数据
> - 每个仓库的库区数据独立存储
> - 即使后端服务不可用，库区管理功能仍然可以正常使用

### 步骤4：选择需要访问的货架

在地图上操作：

- **左键点击格子**：选择/取消选择货架（用于路径规划）
- **右键点击格子**：设置格子所属的库区
- **已选择的货架**：显示为蓝色高亮
- **已设置库区的货架**：显示库区颜色和名称
- **未设置的货架**：显示为灰色
- **大门**：显示为绿色（不可设置）

**操作技巧**：
- 可以先用右键为格子设置库区（货架属于哪个区域）
- 然后用左键选择需要访问的货架（用于路径规划）
- 再次点击已选择的货架可以取消选择
- 可以在"选中的格子"卡片中查看已选择的货架列表
- 点击标签的X号可以取消选择
- 鼠标悬停可以查看格子的详细信息（库区、位置等）

### 步骤5：规划最短路径

在"路径规划"区域：

1. **确认选择**：确保已选择需要访问的货架
2. **调整算法参数**（可选）：
   - **算法迭代次数**：影响计算精度（1000-50000）
   - **初始温度**：影响算法搜索广度（100-10000）
   - **冷却速率**：控制温度下降速度（0.90-0.999）

3. **计算路径**：点击"计算最短路径"按钮
4. **查看结果**：
   - 地图上显示路径线条
   - 显示访问顺序（0、1、2...）
   - 显示总距离（像素单位）
   - 显示访问顺序列表

> 提示：系统会根据地图大小自动调整算法参数

### 步骤6：路径可视化

计算完成后，地图上会显示：

- **绿色圆圈（0）**：起点（大门）
- **蓝色圆圈（1-N）**：访问点（按顺序）
- **红色圆圈（N+1）**：终点（返回大门）
- **蓝色线条**：行走路径（沿着走廊）
- **橙色小点**：目标点（货架下底边中点）

### 步骤7：播放动画

在"路径动画"区域：

1. **调整速度**：使用滑块调整动画播放速度（1-10）
   - 1：非常慢（300ms/步），便于仔细观察每个转折
   - 2：很慢（250ms/步），适合演示讲解
   - 3：慢速（200ms/步），学习路径细节
   - 5：中速（100ms/步），**推荐速度**
   - 7：快速（60ms/步），快速查看
   - 10：极速（20ms/步），快速预览全程

2. **播放动画**：点击"播放动画"按钮
   - 动画从大门开始
   - 沿着蓝色路径移动
   - 经过每个货架
   - 最后返回大门

3. **停止播放**：点击"停止"按钮
   - 立即暂停动画
   - 保持在当前位置
   - 可以继续播放或重置

4. **重置动画**：点击"重置"按钮
   - 停止动画
   - 回到初始状态
   - 可以重新播放

**动画播放时的视觉效果**：

- **橙色动态标记**：显示当前位置，带脉冲效果
- **绿色路径**：已经走过的路径（实时绘制）
- **灰色路径**：尚未走过的路径
- **关键点标记**：起点（绿）、中间点（灰）、终点（红）
- **步骤编号**：显示当前到达的关键点序号

**动画特点**：
- ✅ 严格沿着走廊路径移动
- ✅ 显示所有转折和拐角
- ✅ 实时绘制已走路径
- ✅ 自动播放完成后提示

## 常见使用场景

### 场景1：日常拣货作业

**问题**：今天有订单需要从15个不同货架拣货，如何规划最短路线？

**解决方案**：
1. 在地图上点击选择这15个货架
2. 点击"计算最短路径"
3. 按照显示的顺序进行拣货
4. 可以播放动画培训新员工

**预期效果**：比随机拣货节省30-50%的行走距离

### 场景2：货架布局优化

**问题**：需要重新规划货架布局，减少热门商品的拣货距离

**解决方案**：
1. 在当前布局下，选择热门商品所在货架
2. 记录当前路径总距离
3. 调整地图大小或货架位置（重新生成）
4. 再次选择相同数量的货架，对比距离
5. 选择距离最短的布局方案

### 场景3：效率对比分析

**问题**：想对比不同拣货顺序的效率

**解决方案**：
1. 选择一批货架，计算路径，记录距离
2. 点击"清除路径"
3. 调整算法参数（如提高迭代次数）
4. 重新计算，对比结果
5. 多次计算选择最优方案

## 算法说明

### 双层算法设计

系统采用**双层算法**解决拣货路径规划问题：

#### 第一层：模拟退火算法（访问顺序优化）

用于确定访问货架的最优顺序：

**基本流程**：
```
1. 从大门出发
2. 确定访问所有选中货架的最优顺序
3. 返回大门
4. 目标：最小化总距离
```

**算法特点**：
- ✅ 快速找到接近最优的访问顺序
- ✅ 能跳出局部最优解
- ✅ 适合实时应用
- ⚠️ 不保证全局最优（但通常很接近）

#### 第二层：A*算法（走廊路径查找）

用于在走廊网格中查找实际可行路径：

**基本流程**：
```
1. 将走廊建模为网格系统
2. 使用A*算法在两点间寻找最短路径
3. 路径严格沿着走廊行走
4. 自动避开货架障碍物
```

**算法特点**：
- ✅ 保证找到走廊中的最短路径
- ✅ 路径完全可行（沿着走廊）
- ✅ 自动处理转折和拐角
- ✅ 计算高效（启发式搜索）

### 完整计算流程

```
步骤1：用户选择货架 A、B、C
        ↓
步骤2：模拟退火找最优访问顺序
        例如：大门 → A → C → B → 大门
        ↓
步骤3：对每两个相邻点，使用A*找走廊路径
        - 大门到A的走廊路径
        - A到C的走廊路径  
        - C到B的走廊路径
        - B到大门的走廊路径
        ↓
步骤4：合并所有路径段
        ↓
步骤5：简化路径（移除冗余点）
        ↓
步骤6：在地图上显示完整路径
```

### 路径特点

**真实的走廊路径**：
- 路径包含所有转折点
- 严格沿着走廊网格
- 可以看到明确的上下左右移动
- 符合实际操作

**示例**：
```
从 A(100,100) 到 B(300,300)：
  直线距离 = √[(200)² + (200)²] ≈ 283
  走廊路径 = 向右走200 + 向下走200 = 400
  
实际路径可能是：
  (100,100) → (100,150) → (150,150) → (150,300) → (300,300)
  包含了走廊中的所有转折
```

### 参数调优指南

| 货架数量 | 建议迭代次数 | 建议初始温度 | 建议冷却速率 | 预计耗时 |
|---------|------------|------------|------------|---------|
| 1-5个 | 5,000 | 500 | 0.990 | < 1秒 |
| 6-10个 | 10,000 | 1,000 | 0.995 | 1-2秒 |
| 11-20个 | 20,000 | 2,000 | 0.997 | 2-5秒 |
| 20个以上 | 50,000 | 5,000 | 0.998 | 5-10秒 |

**参数说明**：

1. **迭代次数**
   - 越大越精确，但耗时越长
   - 货架越多，需要的迭代次数越多
   - 推荐：货架数量 × 1000

2. **初始温度**
   - 越高越容易跳出局部最优
   - 建议范围：500-5000
   - 货架较多时应提高

3. **冷却速率**
   - 越接近1，收敛越慢但效果越好
   - 建议范围：0.990-0.998
   - 通常使用0.995

## 实用技巧

### 技巧1：快速选择连续货架

想要选择一排货架？
- 从左到右依次点击即可
- 点错了可以再次点击取消

### 技巧2：查看货架信息

不确定某个货架的位置？
- 将鼠标移动到货架上查看坐标
- 已选择的货架会显示"✓ 已选中"

### 技巧3：清空重来

选错了很多货架？
- 点击"清空选择"按钮一次性清除
- 或者在"选中的格子"列表中逐个删除

### 技巧4：提高路径精度

觉得路径不够优？
1. 增加迭代次数到20000以上
2. 提高初始温度到2000以上
3. 提高冷却速率到0.997以上
4. 多次计算，选择最好的结果

### 技巧5：快速预览

想快速看到路径效果？
1. 降低迭代次数到5000
2. 设置动画速度为10（快速）
3. 快速播放动画

### 技巧6：保存配置

配置会自动保存到浏览器，刷新页面后会自动恢复：
- 地图大小设置
- 选中的货架
- 算法参数

## 常见问题

### Q1: 为什么路径不是最短的？

**原因**：
- 模拟退火是启发式算法，不保证全局最优
- 迭代次数可能不够
- 随机性导致每次结果略有不同

**解决方法**：
- 增加迭代次数（如20000）
- 提高初始温度（如2000）
- 多次计算，选择最好的结果
- 如果货架少于10个，结果通常已经很接近最优

### Q2: 路径为什么不是直线？

**原因**：
- 路径必须沿着走廊行走
- 不能穿过货架
- 使用曼哈顿距离计算

**这是正确的**：实际操作中确实要绕着货架走

### Q3: 计算时间太长怎么办？

**原因**：
- 货架数量太多
- 迭代次数设置太高
- 电脑性能不足

**解决方法**：
- 减少迭代次数（如5000-10000）
- 分批次规划路径
- 使用性能更好的电脑

### Q4: 选择的货架突然消失了？

**原因**：
- 点击了"清空选择"
- 点击了"重新生成地图"
- 切换了浏览器标签页后被清除

**预防措施**：
- 配置会自动保存，刷新页面可恢复
- 重要配置可以截图保存
- 计算路径后记录访问顺序

### Q5: 大门为什么不能选择？

**设计原因**：
- 大门是起点和终点，自动包含在路径中
- 所有路径都从大门出发，回到大门
- 不需要额外选择

### Q6: 下底边中点是什么意思？

**说明**：
- 每个货架有四条边：上、下、左、右
- 下底边中点：货架底部边缘的中间位置
- 路径必须经过这个点才算访问了货架

**为什么是下底边**？
- 符合实际拣货习惯
- 工作人员通常在货架下方操作
- 统一访问位置便于规划

### Q7: 走廊宽度有什么影响？

**影响**：
- 走廊越宽，路径距离越长
- 走廊越窄，地图越紧凑
- 不影响最优路径的选择，只影响总距离

**建议**：
- 实际规划：设置为实际走廊宽度
- 展示演示：设置为20-30px
- 密集布局：设置为10-15px

## 性能建议

### 推荐配置

**小规模（< 10个货架）**：
- 地图大小：10行 × 15列
- 走廊宽度：20px
- 迭代次数：10,000
- 预计耗时：1-2秒

**中等规模（10-20个货架）**：
- 地图大小：15行 × 20列
- 走廊宽度：20px
- 迭代次数：20,000
- 预计耗时：3-5秒

**大规模（> 20个货架）**：
- 地图大小：20行 × 25列
- 走廊宽度：15px
- 迭代次数：30,000
- 预计耗时：5-10秒

### 性能优化

1. **控制地图大小**
   - 建议不超过20×25
   - 太大会影响显示和计算性能

2. **合理设置迭代次数**
   - 不是越大越好
   - 根据货架数量调整

3. **分批规划**
   - 如果货架很多，可以分区域规划
   - 然后合并路径

## 动画速度说明

### 速度档位表

动画速度分为10个档位，提供从极慢到极快的观看体验：

| 档位 | 速度(ms/步) | 说明 | 适用场景 |
|-----|-----------|------|---------|
| 1 | 300 | 非常慢 | 仔细观察每个转折，培训讲解 |
| 2 | 250 | 很慢 | 演示路径细节，学习路线 |
| 3 | 200 | 慢速 | 清晰展示路径，便于理解 |
| 4 | 150 | 较慢 | 舒适的观看速度 |
| 5 | 100 | **中速（推荐）** | 平衡速度和清晰度 |
| 6 | 80 | 较快 | 快速查看路径 |
| 7 | 60 | 快速 | 快速预览效果 |
| 8 | 40 | 很快 | 加速查看 |
| 9 | 30 | 非常快 | 快速扫描 |
| 10 | 20 | 极速 | 最快速度预览全程 |

### 使用建议

**新用户/培训场景**：
- 使用速度 **1-3**
- 便于仔细观察路径的每个转折
- 适合讲解和学习

**日常使用**：
- 使用速度 **5-7**
- 效率最佳，清晰度高
- 推荐大多数情况使用

**快速检查**：
- 使用速度 **8-10**
- 快速验证路径正确性
- 节省时间

### 速度与路径长度

动画时间取决于路径长度和速度设置：

```
动画总时长 = 路径点数 × 速度(ms/步) ÷ 1000

示例：
- 路径500个点，速度1（300ms）：500 × 300 = 150秒 ≈ 2.5分钟
- 路径500个点，速度5（100ms）：500 × 100 = 50秒
- 路径500个点，速度10（20ms）：500 × 20 = 10秒
```

## 技术细节

### 路径计算流程

```
1. 用户选择货架 A、B、C
2. 系统获取各货架的下底边中点坐标
3. 构建问题：大门 → A/B/C（某个顺序）→ 大门
4. 运行模拟退火算法
5. 尝试不同的访问顺序
6. 找到总距离最短的顺序
7. 生成完整路径（包含走廊路径）
8. 显示在地图上
```

### 数据结构

```javascript
// 货架对象
{
  row: 1,           // 行号
  col: 2,           // 列号
  x: 100,           // 屏幕X坐标
  y: 150,           // 屏幕Y坐标
  targetX: 130,     // 下底边中点X
  targetY: 210,     // 下底边中点Y
  selected: true    // 是否选中
}

// 路径结果
{
  path: [           // 路径点数组
    {x: 100, y: 50},
    {x: 130, y: 210},
    ...
  ],
  distance: 1234.5, // 总距离
  visitOrder: [     // 访问顺序
    货架对象1,
    货架对象2,
    ...
  ]
}
```

## 后续优化方向

### 短期优化
- [ ] 支持拖拽选择多个货架
- [ ] 添加路径长度单位转换（像素→米）
- [ ] 支持导出路径数据
- [ ] 添加历史记录功能

### 中期优化
- [ ] 支持不同类型的货架（高货架、低货架）
- [ ] 支持障碍物设置（不可通行区域）
- [ ] 多种算法对比（遗传算法、蚁群算法）
- [ ] 路径优化建议（瓶颈分析）

### 长期优化
- [ ] 3D可视化
- [ ] 实时定位和导航
- [ ] 多人协同拣货路径规划
- [ ] 基于历史数据的智能推荐

## 联系支持

如有问题或建议，请联系系统管理员或提交反馈。

---

**版本**：v1.0.0  
**更新日期**：2025-11-24  
**文档作者**：WMS开发团队
