# 仓库地图系统 - 离线使用指南

## 概述

仓库地图系统设计为**可离线使用**的应用，即使后端服务不可用或网络断开，主要功能仍然可以正常工作。

## 🔌 离线功能支持

### ✅ 完全可用的功能

以下功能在离线状态下完全可用：

1. **地图创建和配置**
   - 设置地图大小（行列数）
   - 调整格子大小和走廊宽度
   - 生成地图布局

2. **库区管理**
   - 添加新库区
   - 编辑库区名称和编号
   - 删除库区
   - 右键设置格子所属库区

3. **货架选择**
   - 左键选择需要访问的货架
   - 查看选中的货架列表
   - 取消选择

4. **路径规划**
   - 计算最短拣货路径
   - 使用模拟退火算法优化
   - 查看路径总距离和访问顺序

5. **动画播放**
   - 播放路径动画
   - 调整播放速度
   - 暂停和重置

6. **数据持久化**
   - 所有配置自动保存到浏览器本地
   - 刷新页面后数据保留

### ⚠️ 需要后端支持的功能

以下功能需要连接后端服务：

1. **仓库列表查询**
   - 从数据库加载仓库列表
   - 解决方案：使用默认仓库或手动指定

2. **库区数据同步**
   - 从数据库同步库区信息
   - 解决方案：使用本地创建的库区数据

3. **配置备份到服务器**
   - 将地图配置保存到数据库
   - 解决方案：使用浏览器本地存储

## 📦 数据存储机制

### LocalStorage 存储内容

系统使用浏览器的 LocalStorage 存储以下数据：

```javascript
// 地图配置（全局）
'warehouseMapData' = {
  mapConfig: { rows, cols, cellSize, gap },
  selectedIndices: [...]  // 选中的货架
}

// 每个仓库的库区数据
'warehouse_areas_{warehouseId}' = [
  {
    id: 'area-xxx',
    areaName: 'A区',
    areaCode: 'A001',
    warehouseId: 1,
    color: '#409EFF'
  },
  ...
]
```

### 数据持久性

- ✅ 数据会一直保存，直到手动清除
- ✅ 刷新页面不会丢失数据
- ✅ 关闭浏览器后重新打开仍然保留
- ⚠️ 清除浏览器缓存会删除所有本地数据
- ⚠️ 隐私模式/无痕模式下数据可能不会保存

## 🚀 离线使用步骤

### 场景1：完全离线使用

如果没有后端服务或网络连接：

1. **首次使用**：
   ```
   打开页面
     ↓
   系统检测到无法连接后端
     ↓
   自动创建默认仓库和库区
     ↓
   开始使用地图功能
   ```

2. **配置库区**：
   - 点击"添加库区"按钮
   - 编辑库区名称和编号
   - 右键设置格子所属库区

3. **规划路径**：
   - 左键选择货架
   - 计算最短路径
   - 播放动画查看

4. **保存工作**：
   - 所有操作自动保存到本地
   - 无需手动保存

### 场景2：在线转离线

如果开始时有网络，后来断开：

1. **已加载的数据**：
   - 仓库列表（已缓存）
   - 库区数据（已缓存）
   - 地图配置（本地存储）

2. **继续工作**：
   - 所有核心功能仍然可用
   - 修改会保存到本地
   - 网络恢复后可手动同步（如果需要）

### 场景3：临时演示

用于培训或演示，不需要真实数据：

1. **快速开始**：
   ```
   打开页面（跳过登录）
     ↓
   使用默认仓库
     ↓
   添加库区
     ↓
   开始演示路径规划
   ```

2. **演示内容**：
   - 创建地图布局
   - 设置库区位置
   - 选择多个货架
   - 计算并播放路径动画
   - 讲解算法原理

## ⚙️ 配置说明

### 默认配置

系统首次使用或后端不可用时的默认配置：

```javascript
// 默认地图配置
mapConfig = {
  rows: 10,      // 10行
  cols: 15,      // 15列
  cellSize: 60,  // 格子60px
  gap: 20        // 走廊20px
}

// 默认库区（5个）
defaultAreas = [
  { name: 'A区', code: 'A001', color: '#409EFF' },
  { name: 'B区', code: 'B001', color: '#67C23A' },
  { name: 'C区', code: 'C001', color: '#E6A23C' },
  { name: 'D区', code: 'D001', color: '#F56C6C' },
  { name: 'E区', code: 'E001', color: '#909399' }
]
```

### 自定义配置

可以在界面上修改所有配置：

- 地图大小：3-30行/列
- 格子大小：40-100px
- 走廊宽度：10-40px
- 库区数量：不限
- 库区名称：可编辑
- 库区颜色：自动分配（可扩展为可选）

## 🔄 数据迁移和备份

### 导出配置

手动导出当前配置（开发者工具）：

```javascript
// 在浏览器控制台执行
const mapData = localStorage.getItem('warehouseMapData');
const areasData = localStorage.getItem('warehouse_areas_1');

console.log('地图配置:', mapData);
console.log('库区配置:', areasData);

// 复制并保存到文件
```

### 导入配置

恢复之前的配置：

```javascript
// 在浏览器控制台执行
localStorage.setItem('warehouseMapData', '{"mapConfig":...}');
localStorage.setItem('warehouse_areas_1', '[{"id":"area-1",...}]');

// 刷新页面
location.reload();
```

### 清除数据

重置所有配置：

```javascript
// 在浏览器控制台执行
localStorage.clear();
location.reload();
```

## 🐛 故障排除

### 问题1：数据丢失

**症状**：刷新后配置消失

**原因**：
- 浏览器隐私模式
- LocalStorage被禁用
- 浏览器缓存被清除

**解决方案**：
1. 使用普通浏览器模式
2. 检查浏览器设置中的存储权限
3. 定期手动导出配置备份

### 问题2：无法添加库区

**症状**：点击"添加库区"无反应

**原因**：
- 未选择仓库

**解决方案**：
1. 先在"仓库选择"下拉框中选择仓库
2. 如果下拉框为空，刷新页面

### 问题3：路径计算失败

**症状**：点击"计算最短路径"后报错

**原因**：
- 未选择任何货架
- 选择的货架数量不足

**解决方案**：
1. 至少选择1个货架
2. 确保选中的格子显示为蓝色

### 问题4：后端错误提示

**症状**：控制台显示API错误

**原因**：
- 后端服务未启动
- 网络连接问题

**解决方案**：
- 这是正常现象，不影响使用
- 系统会自动切换到离线模式
- 可以安全地忽略这些错误

## 💡 最佳实践

### 培训和演示

1. **准备**：
   - 提前配置好示例地图
   - 设置有代表性的库区布局
   - 准备典型的拣货路线

2. **演示**：
   - 使用中速（档位5）播放动画
   - 讲解路径规划的每个步骤
   - 对比不同库区布局的效率

3. **互动**：
   - 让学员自己选择货架
   - 让学员尝试不同的库区设置
   - 讨论如何优化布局

### 日常使用

1. **规划**：
   - 根据实际仓库创建地图
   - 准确设置库区位置
   - 定期更新库区信息

2. **优化**：
   - 记录常用的拣货路线
   - 对比不同路线的距离
   - 调整库区布局减少距离

3. **维护**：
   - 定期备份配置
   - 记录优化后的改进
   - 分享最佳实践

## 📚 相关文档

- [完整使用说明](./仓库地图使用说明.md)
- [快速入门指南](./仓库地图快速入门.md)
- [测试指南](./测试指南.md)
- [部署指南](./部署指南.md)

## 🆘 获取帮助

如果遇到问题：

1. 查看本文档的"故障排除"部分
2. 检查浏览器控制台的错误信息
3. 尝试清除缓存并重新加载
4. 联系系统管理员

---

**提示**：离线功能让您随时随地都能使用仓库地图系统，无需担心网络连接问题！🎉

