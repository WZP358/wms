# 条形码反向操作功能使用说明

## 功能概述

本系统支持通过扫描入库单或出库单的条形码，快速创建反向操作单据：
- **扫描入库单条形码** → 一键创建出库单（销售出库）
- **扫描出库单条形码** → 一键创建入库单（退货入库）

这个功能极大地简化了退货、销售等常见业务场景的操作流程。

## 功能特性

### 1. 扫描入库单 → 一键转出库

**业务场景：** 商品已入库，现在需要销售出库

**使用步骤：**

1. 打开 **入库单管理页面**
2. 在"输入条形码"输入框中，扫描或输入入库单号
3. 按回车后，系统弹出选择框：
   ```
   找到入库单【RK202411280001】，请选择操作：
   [一键转出库]  [查看入库单]
   ```
4. 点击 **"一键转出库"** 按钮
5. 系统自动检查：
   - ✅ 入库单必须是"已入库"状态
   - ✅ 入库单必须有商品明细
6. 检查通过后，系统会：
   - 自动生成出库单号
   - 自动填充商品信息、仓库、库区等
   - 跳转到出库单编辑页面
   - 设置订单号为原入库单号（关联追溯）
7. 核对信息后，点击"暂存"或"出库"完成操作

**自动填充的信息：**
- ✓ 出库单号（自动生成）
- ✓ 出库类型（销售出库）
- ✓ 仓库/库区（沿用入库单）
- ✓ 客户/供应商（沿用入库单）
- ✓ 订单号（关联原入库单号）
- ✓ 商品明细（数量、批号、生产日期、过期日期等）
- ✓ 备注（标注"根据入库单【XXX】创建"）

### 2. 扫描出库单 → 一键转入库

**业务场景：** 商品已出库，现在需要退货入库

**使用步骤：**

1. 打开 **出库单管理页面**
2. 在"输入条形码"输入框中，扫描或输入出库单号
3. 按回车后，系统弹出选择框：
   ```
   找到出库单【CK202411280001】，请选择操作：
   [一键转入库]  [查看出库单]
   ```
4. 点击 **"一键转入库"** 按钮
5. 系统自动检查：
   - ✅ 出库单必须是"已出库"状态
   - ✅ 出库单必须有商品明细
6. 检查通过后，系统会：
   - 自动生成入库单号
   - 自动填充商品信息、仓库、库区等
   - 跳转到入库单编辑页面
   - 设置订单号为原出库单号（关联追溯）
7. 核对信息后，点击"暂存"或"入库"完成操作

**自动填充的信息：**
- ✓ 入库单号（自动生成）
- ✓ 入库类型（退货入库）
- ✓ 仓库/库区（沿用出库单）
- ✓ 客户/供应商（沿用出库单）
- ✓ 订单号（关联原出库单号）
- ✓ 商品明细（数量、批号、生产日期、过期日期等）
- ✓ 备注（标注"根据出库单【XXX】创建"）

## 使用场景示例

### 场景1：客户退货

```
流程：
1. 客户购买商品（出库单：CK202411280001）
2. 客户要求退货
3. 扫描出库单条形码 CK202411280001
4. 点击"一键转入库"
5. 系统自动创建退货入库单
6. 商品重新入库
```

### 场景2：商品销售

```
流程：
1. 采购商品入库（入库单：RK202411280001）
2. 需要销售这批商品
3. 扫描入库单条形码 RK202411280001
4. 点击"一键转出库"
5. 系统自动创建销售出库单
6. 完成商品出库
```

### 场景3：样品退回

```
流程：
1. 寄出样品（出库单：CK202411280002）
2. 客户退回样品
3. 扫描出库单条形码 CK202411280002
4. 点击"一键转入库"
5. 样品重新入库
```

## 状态检查说明

### 入库单转出库的前置条件

| 检查项 | 要求 | 提示信息 |
|--------|------|----------|
| 入库状态 | 必须是"已入库"（status=1） | "入库单【XXX】未入库，无法转出库！" |
| 商品明细 | 必须有商品明细数据 | "入库单没有商品明细，无法转出库！" |

### 出库单转入库的前置条件

| 检查项 | 要求 | 提示信息 |
|--------|------|----------|
| 出库状态 | 必须是"已出库"（status=1） | "出库单【XXX】未出库，无法转入库！" |
| 商品明细 | 必须有商品明细数据 | "出库单没有商品明细，无法转入库！" |

## 数据追溯

系统通过以下方式保证数据可追溯：

1. **订单号关联**：转换后的单据的订单号字段，会自动填充原单号
   - 示例：根据入库单 RK202411280001 创建的出库单，订单号为 RK202411280001

2. **备注信息**：自动在备注中标注来源
   - 示例：`根据入库单【RK202411280001】创建`

3. **独立单号**：转换后的单据有独立的新单号
   - 入库单 → 出库单：RK202411280001 → CK202411280002
   - 出库单 → 入库单：CK202411280001 → RK202411280002

## 操作权限

### 所需权限
- **入库单转出库**：需要 `wms:receipt:all` 和 `wms:shipment:all` 权限
- **出库单转入库**：需要 `wms:shipment:all` 和 `wms:receipt:all` 权限

### 角色建议
- 仓库管理员：应同时拥有入库和出库权限
- 业务员：根据实际需要配置相应权限

## 注意事项

### ⚠️ 重要提示

1. **状态限制**
   - 只有已完成的单据才能转换（已入库的入库单、已出库的出库单）
   - 待处理或已作废的单据无法转换

2. **数据核对**
   - 转换后会自动填充数据，但仍需要人工核对
   - 特别注意商品数量、批号、日期等信息
   - 如有部分商品不需要退货/出库，可在编辑页面删除

3. **库存影响**
   - 一键转出库：需要确保库存充足
   - 一键转入库：会增加相应商品的库存

4. **数据修改**
   - 转换后的单据可以在提交前修改
   - 可以调整数量、删除商品、修改仓库等
   - 修改后不影响原单据

5. **业务类型**
   - 入库转出库：自动设置为"销售出库"类型
   - 出库转入库：自动设置为"退货入库"类型
   - 如需其他类型，可在编辑页面手动修改

## 常见问题

**Q: 为什么提示"未入库，无法转出库"？**
A: 只有已完成入库的单据才能转出库，请先完成入库操作。

**Q: 转换后的单据可以修改吗？**
A: 可以，转换后会跳转到编辑页面，您可以修改任何信息后再提交。

**Q: 如果只想退一部分商品怎么办？**
A: 转换后，在编辑页面可以删除不需要的商品，或者修改数量。

**Q: 转换会影响原单据吗？**
A: 不会，转换操作会创建全新的单据，原单据不受影响。

**Q: 扫描条形码后，我不想转换了怎么办？**
A: 在弹出的选择框中点击"查看入库单"或"查看出库单"即可，也可以直接关闭对话框。

**Q: 可以多次转换同一个单据吗？**
A: 可以，一个入库单可以创建多个出库单，反之亦然。例如分批退货的场景。

## 技术实现

### 数据流转

```
扫描条形码
   ↓
查询原单据
   ↓
状态检查
   ↓
用户选择操作
   ↓
生成新单号
   ↓
构建转换数据
   ↓
跳转编辑页面
   ↓
自动填充表单
   ↓
用户核对提交
```

### 数据存储
- 使用 localStorage 临时存储转换数据
- 跳转到编辑页面后自动读取并清除
- 确保数据安全和页面刷新后的正常使用

## 更新历史

- **2025-11-28:** 初始版本，支持入库单转出库、出库单转入库功能

