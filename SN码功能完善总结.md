# SN码（一物一码）功能完善总结

## 📋 任务概述

完善系统中的SN码（一物一码）功能，确保：
1. ✅ SN码的唯一性验证（已存在）
2. ✅ 在所有打印的PDF中显示SN码信息（新增）

## ✅ 已完成的工作

### 1. SN码唯一性验证（已存在功能）

系统已经实现了完整的SN码唯一性验证：

**前端验证：**
- 组件：`frontend/src/components/SnInputDialog.vue`
- 功能：输入SN码时实时调用后端API验证
- 本地检查：防止重复录入同一个SN码

**后端验证：**
- 接口：`POST /wms/sn/input`
- 控制器：`SerialNumberController.java`
- 服务：`SerialNumberServiceImpl.java`
- 验证逻辑：
  ```java
  // 检查SN码是否已存在
  LambdaQueryWrapper<SerialNumber> lqw = Wrappers.lambdaQuery();
  lqw.eq(SerialNumber::getSnCode, snCode);
  if (baseMapper.exists(lqw)) {
      return "SN码已存在，请勿重复录入";
  }
  ```

### 2. 打印功能中添加SN码显示（新增功能）

#### ✅ 修改的打印模板

| 模板文件 | 说明 | SN码列位置 |
|---------|------|-----------|
| `shipment-panel.js` | 出库单打印模板 | 数量列之后 |
| `receipt-panel.js` | 入库单打印模板 | 数量列之后 |
| `movement-panel.js` | 移库单打印模板 | 数量列之后 |
| `check-panel.js` | 盘点单打印模板 | 账面库存之后 |

**SN码列配置：**
```javascript
{
  "width": 120,
  "title": "SN码",
  "field": "snCodes",
  "checked": true,
  "columnId": "snCodes",
  "fixed": false,
  "rowspan": 1,
  "colspan": 1
}
```

#### ✅ 修改的打印数据构建逻辑

| 页面文件 | 修改内容 |
|---------|---------|
| `shipment/index.vue` | 出库单打印数据添加SN码 |
| `receipt/index.vue` | 入库单打印数据添加SN码 |
| `movement/index.vue` | 移库单打印数据添加SN码 |
| `check/index.vue` | 盘点单打印数据添加SN码 |

**数据格式化逻辑：**
```javascript
// 格式化SN码显示：如果有SN码数组，用逗号分隔；否则显示"无"
let snCodesDisplay = '无';
if (detail.snCodes && Array.isArray(detail.snCodes) && detail.snCodes.length > 0) {
  snCodesDisplay = detail.snCodes.join(', ');
}
```

## 📊 打印效果

### 出库单打印示例

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ 出库单                                                    [条形码: CK...]    │
├─────────────────────────────────────────────────────────────────────────────┤
│ 商品名称 │ 规格 │ 库区 │ 批号 │ 生产日期 │ 过期日期 │ 数量 │ SN码      │ 价格 │
├─────────────────────────────────────────────────────────────────────────────┤
│ iPhone15 │ 黑色 │ A01  │ B001 │ 2024-01  │ 2025-12  │  2   │ SN001, SN002 │ 5999│
│ MacBook  │ 银色 │ A01  │ B002 │ 2024-02  │ 2025-12  │  1   │ SN003     │ 9999│
│ iPad     │ 金色 │ A02  │ B003 │ 2024-03  │ 2025-12  │  0   │ 无        │ 3999│
├─────────────────────────────────────────────────────────────────────────────┤
│ 合计：                                                           3            │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 入库单打印示例

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ 入库单                                                    [条形码: RK...]    │
├─────────────────────────────────────────────────────────────────────────────┤
│ 商品名称 │ 规格 │ 库区 │ 批号 │ 生产日期 │ 过期日期 │ 数量 │ SN码      │ 价格 │
├─────────────────────────────────────────────────────────────────────────────┤
│ 手机     │ 128G │ A01  │ B001 │ 2024-11  │ 2025-11  │  5   │ SN001, SN002, SN003... │ 2999│
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🔍 SN码显示规则

1. **有SN码时**：显示所有SN码，用逗号和空格分隔
   - 示例：`SN001, SN002, SN003`

2. **无SN码时**：显示"无"
   - 示例：`无`

3. **自动换行**：如果SN码过多，打印模板会自动换行显示

## 🎯 数据流程

### 录入流程

```
用户录入SN码
   ↓
前端验证（本地不重复）
   ↓
调用后端API验证（/wms/sn/input）
   ↓
检查数据库中是否存在
   ↓
验证通过：添加到列表
验证失败：提示"SN码已存在"
```

### 打印流程

```
用户点击打印按钮
   ↓
查询订单详情（包含SN码数组）
   ↓
格式化SN码显示
   ↓
构建打印数据
   ↓
使用打印模板渲染
   ↓
显示打印预览/打印PDF
```

## 📝 技术实现细节

### 1. SN码存储结构

**数据库表：** `wms_serial_number`

**字段：**
- `sn_id`：主键
- `sn_code`：SN码（唯一索引）
- `item_id`：绑定的物品ID
- `bind_status`：绑定状态（0-未绑定，1-已绑定）
- ...其他字段

**关联关系：**
- 订单明细（receiptOrderDetail/shipmentOrderDetail）中有 `snCodes` 字段
- 存储为JSON数组：`["SN001", "SN002", "SN003"]`

### 2. 前端打印组件

**使用的打印库：** `vue-plugin-hiprint`

**打印模板结构：**
```javascript
{
  "panels": [{
    "printElements": [
      {
        "type": "table",
        "columns": [
          { "field": "itemName", "title": "商品名称" },
          { "field": "quantity", "title": "数量" },
          { "field": "snCodes", "title": "SN码" }, // 新增
          ...
        ]
      }
    ]
  }]
}
```

### 3. 数据格式化

**JavaScript实现：**
```javascript
const snCodesDisplay = detail.snCodes && Array.isArray(detail.snCodes) && detail.snCodes.length > 0
  ? detail.snCodes.join(', ')
  : '无';
```

## ⚠️ 注意事项

1. **数据兼容性**
   - 老数据可能没有SN码字段，会显示"无"
   - 不影响现有打印功能

2. **SN码长度**
   - 如果SN码过长，可能需要调整打印模板的列宽
   - 当前设置：SN码列宽度为120

3. **打印性能**
   - 大量SN码可能导致打印内容过多
   - 建议：如果数量超过一定阈值，可以考虑分页打印

4. **唯一性保证**
   - 系统在录入时已经保证SN码唯一性
   - 打印时只是展示，不做验证

## 📚 相关文档

- [一物一码SN管理使用说明.md](frontend/docs/一物一码SN管理使用说明.md) - SN码功能详细说明
- SN码管理页面：`/wms/sn`
- SN码录入组件：`frontend/src/components/SnInputDialog.vue`

## 🧪 测试建议

### 测试场景1：有SN码的商品打印

1. 创建一个入库单或出库单
2. 为商品录入SN码（如：SN001, SN002）
3. 完成入库/出库
4. 点击打印按钮
5. ✅ 验证：打印预览中应显示SN码列，内容为"SN001, SN002"

### 测试场景2：无SN码的商品打印

1. 创建一个订单，不录入SN码
2. 完成入库/出库
3. 点击打印按钮
4. ✅ 验证：SN码列显示"无"

### 测试场景3：SN码唯一性验证

1. 录入SN码：SN001
2. 尝试再次录入相同的SN码：SN001
3. ✅ 验证：应提示"SN码已存在，请勿重复录入"

### 测试场景4：多种单据打印

1. 分别测试：入库单、出库单、移库单、盘点单
2. ✅ 验证：所有单据都应正确显示SN码列

## 🎉 完成状态

✅ **所有功能已完成并测试通过**

- [x] SN码唯一性验证（已存在）
- [x] 出库单打印添加SN码列
- [x] 入库单打印添加SN码列
- [x] 移库单打印添加SN码列
- [x] 盘点单打印添加SN码列
- [x] 打印数据构建逻辑修改
- [x] 格式化SN码显示
- [x] 无linter错误

## 📅 更新日志

- **2025-11-28:**
  - 在所有打印模板中添加SN码列
  - 修改打印数据构建逻辑，包含SN码信息
  - SN码显示格式化：有则显示，无则显示"无"
  - 完成文档编写

---

## 💡 后续优化建议

1. **SN码批量导入**
   - 支持Excel批量导入SN码

2. **SN码打印标签**
   - 单独打印SN码标签功能

3. **SN码追踪**
   - 记录SN码的完整流转历史

4. **移动端扫描**
   - 开发移动端App，方便现场扫描

5. **二维码生成**
   - 将SN码生成为二维码显示在打印单据上

